name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  python-checks:
    name: Python Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd auditor
          pip install -e ".[dev]"

      - name: Run ruff linter
        run: |
          cd auditor
          ruff check .

      - name: Run pytest
        run: |
          cd auditor
          pytest -v

  terraform-checks:
    name: Terraform Format & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Terraform Format Check
        run: |
          cd terraform/envs/dev
          terraform fmt -check -recursive ../../

      - name: Terraform Init
        run: |
          cd terraform/envs/dev
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform/envs/dev
          terraform validate

  security-scan:
    name: Security Scan (Optional)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install checkov
        run: |
          pip install checkov || echo "checkov installation failed, skipping"
        continue-on-error: true

      - name: Run checkov scan
        run: |
          if command -v checkov &> /dev/null; then
            checkov -d terraform/ --compact --quiet || echo "checkov scan completed with findings"
          else
            echo "checkov not available, skipping security scan"
          fi
        continue-on-error: true

  integration:
    name: Integration Check
    runs-on: ubuntu-latest
    needs: [python-checks, terraform-checks]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install auditor
        run: |
          cd auditor
          pip install -e .

      - name: Run audit in dry-run mode
        run: |
          cd auditor
          python -m databricks_auditor.cli audit --out ../reports --format json,md,html

      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        with:
          name: audit-reports
          path: reports/
          retention-days: 30

      - name: Check reports generated
        run: |
          ls -la reports/
          test -f reports/audit_report.json
          test -f reports/audit_report.md
          test -f reports/audit_report.html
          echo "âœ… All report formats generated successfully"
